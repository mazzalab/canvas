<!doctype html>
{% extends 'base.html' %}
{% block head %}
{{ super() }}
<style>
  label{
    font-weight: normal!important;
    font-size:90%;
  }
  input[type="radio"]{
    margin: 3px 0 0;
  }
</style>
<script>
    function readTextFile(file) {
      var rawFile = new XMLHttpRequest();
      rawFile.overrideMimeType("application/json");
      rawFile.open("GET", file, true);
      rawFile.onreadystatechange = function() {
          if (rawFile.readyState === 4 && rawFile.status == "200") {
              return rawFile.responseText;
          }
      }
      rawFile.send(null)
    }
</script>

<script id="json-reader">

  var jsonData;
  $.ajax({
    dataType: "json",
    url: "{{ json_out }}",
    async: false,
    success: function(data){jsonData = data}
  });

</script>

<script>
    var cnvselection=-1;
    function updateGenes(cnvselection, jsonData) {
      {% for c in choices %}
        console.log("FIELD"+"{{c}}")
      $('#sel-{{c}}').empty();
      console.log("UPDATING "+ '#sel-{{c}}')
      console.log("CHOICE: "+cnvselection)
      if (cnvselection==-1){
        console.log("no choice")
      }else{
        console.log("CORRECT CHOICE: ")
        console.log(jsonData[cnvselection])
        var splitgenes = jsonData[cnvselection].{{c}}_inside.split(',')
          for (i = 0; i < splitgenes.length; i++) {
            // console.log(splitgenes[i])
            if(splitgenes[i]!='.'){
              $('#sel-{{c}}').append($('<option></option>').attr('value', splitgenes[i]).text(splitgenes[i]));
            }
          }
      }
      {% endfor %}
    };

</script>

{% endblock %}

{% block title %}Results{% endblock %}
{% block navbar %}
{{ super() }}
{% endblock %}

{% block content %}
<div class="parallax filter-gradient blue" data-color="blue" style="height:100px !important;">
    <div class="parallax-background">
        <img src="../static/img/dna2.png">
    </div>
</div>

<div class= "section section-gray section-clients">
  <div>
    <select id="cnv-dropdown" name="CNVs" style="margin-left:30px;"></select>
    <script>
        let dropdown = $('#cnv-dropdown');

        // dropdown.empty();

        dropdown.append('<option selected="true" value="-1" disabled>Choose CNV</option>');
        dropdown.prop('selectedIndex', 0);

        // Populate dropdown with list of CNVs
        $.getJSON("{{ json_out }}", function (data) {
        $.each(data, function (key, entry) {
          dropdown.append($('<option></option>').attr('value', entry.index).text(entry.CHR+":"+entry.START+"-"+entry.END));
        })
        });

        document.getElementById('cnv-dropdown').addEventListener('change',function(){
          var cnvdrop = document.getElementById("cnv-dropdown");
          cnvselection = cnvdrop.options[cnvdrop.selectedIndex].value;
          console.log("HELLOOOO "+cnvselection)
          updateGenes(cnvselection, jsonData);
        });

    </script>
    <br>
    <div class="row" style="margin-top: 35px; margin-right: 15px; margin-left: 15px;">
    {% for c in choices %}
      <div class="col-md-4">
        <div class="panel panel-info">
          <div class="panel-heading" style="font-weight: bold; color: #ffffff; background-color: #307ba0; border-color: #307ba0">{{ c }}</div>
          <div class="panel-body">
            <form>
              <div class="radio-inline">
                <label class="form-check-label-{{c}}">
                <input type="radio" class="form-check-input" name="{{c}}" id="inside-{{c}}" value="inside-{{c}}"
                checked>inside
                </label>
              </div>
              <div class="radio-inline">
                <label class="form-check-label-{{c}}">
                <input type="radio" class="form-check-input" name="{{c}}" id="cross-{{c}}" value="cross-{{c}}"
                unchecked>cross
                </label>
              </div>
              <div class="radio-inline">
                <label class="form-check-label-{{c}}">
                <input type="radio" class="form-check-input" name="{{c}}" id="distal-{{c}}" value="distal-{{c}}"
                unchecked>distal
                </label>
              </div>
              <div class="help-tip">
                <p>You can select among three subsets of <b>{{ c }}</b>s:<br /><br />
                  &nbsp;&nbsp;- <b>inside</b>:<br />
                  &nbsp;&nbsp;- <b>cross</b>:<br />
                  &nbsp;&nbsp;- <b>distal</b>:<br />
              </p>
              </div>
              <select multiple class="form-control" id="sel-{{c}}"></select>
              <div>

              </div>
              <button class="btn" type="button" id="getSelectsBtn-{{c}}"
              style="margin-top:10px; padding: 4px 8px; border-width: 1px;">
              <img src="../static/img/gc_small.png" /></button>
              <script>
                $(document).ready(function() {
                    $("#getSelectsBtn-{{c}}").click(function(){
                        $.each($("#sel-{{c}} option:selected"), function(){
                          window.open("https://www.genecards.org/cgi-bin/carddisp.pl?gene="+$(this).val(), '_blank');
                          window.focus();
                          console.log("You have selected - " + $(this).val());
                        });
                    });
                });
              </script>
            </form>
          </div>
        </div>
      </div>
    {% endfor %}
    </div>

  </div>
  <p>
    <a href="{{file_out}}" download="{{download_name}}">Download results as xlsx</a>
  </p>
</div>
{% endblock %}
