<!doctype html>
{% extends 'base.html' %}
{% block head %}
{{ super() }}
<link href="../static/css/arrow.css" rel="stylesheet"/>

<script>
    $(document).on("click", function () {
        document.getElementById("arrow").style.display = "none";
    });
</script>

<style>
  label{
    font-weight: normal!important;
    font-size:90%;
  }
  input[type="radio"]{
    margin: 3px 0 0;
  }
</style>
<script>
    function readTextFile(file) {
      var rawFile = new XMLHttpRequest();
      rawFile.overrideMimeType("application/json");
      rawFile.open("GET", file, true);
      rawFile.onreadystatechange = function() {
          if (rawFile.readyState === 4 && rawFile.status == "200") {
              return rawFile.responseText;
          }
      }
      rawFile.send(null)
    }
</script>

<script id="json-reader">

  var jsonData;
  var mirbase_jsonData;
  var extra_jsonData;

  console.log("JSON MAIN YES")
  console.log("{{ json_out }}")
  $.ajax({
    dataType: "json",
    url: "{{ json_out }}",
    async: false,
    success: function(data){
      jsonData = data;
    }
  });

  if ({{choices|tojson|safe}}.includes('mirbase')){
    $.ajax({
      dataType: "json",
      url: "{{ json_out }}".replace(".json", "_mirbase.json"),
      async: false,
      success: function(data){mirbase_jsonData = data}
    });
  }

  // if ({{choices|tojson|safe}}.includes('enhancer')){
  //   console.log("ENHANCER YES")
  //   console.log("{{ json_out }}".replace(".json", "_extra.json"))
  //   $.ajax({
  //     dataType: "json",
  //     url: "{{ json_out }}".replace(".json", "_extra.json"),
  //     async: false,
  //     success: function(data){extra_jsonData = data},
  //     error: function (data) {
  //       var responseText=JSON.parse(data.responseText);
  //       alert("Error(s) while building:\n"+responseText.messages);}
  //   });
  // }


</script>

<script type ="text/javascript">
  $(document).on("click", "#loadpage", function () {
      var values = $('#modal-sel').val();

      // set fso = CreateObject("Scripting.FileSystemObject");
      // set s = fso.CreateTextFile("\test.txt", True);
      var element = document.createElement('a');
      element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(values.join("\n")));
      element.setAttribute('download', "selected_genes.txt");

      element.style.display = 'none';
      document.body.appendChild(element);

      element.click();

      document.body.removeChild(element);
      // for (i=0; i< )
      // s.writeline(document.passForm.input1.value);
      // s.writeline(document.passForm.input2.value);
      // s.writeline(document.passForm.input3.value);
      // s.Close();
    });
</script>

<script>
    jQuery(function($) {
      var panelList = $('.draggablePanelList');

      panelList.sortable({
          // Only make the .panel-heading child elements support dragging.
          // Omit this to make then entire <li>...</li> draggable.
          handle: '.panel-heading',
          update: function() {
              $('.panel', panelList).each(function(index, elem) {
                   var $listItem = $(elem),
                       newIndex = $listItem.index();

                   // Persist the new indices.
              });
          }
      });
    });

</script>
<script>
    var cnvselection=-1;
    var position;
    function updateGenes(cnvselection, jsonData) {
      {% for c in choices %}
          var splitchar = ';';
          {% if (c!='mirbase' and c!='gene') %}
                $('#sel-{{c}}').empty();
                if (cnvselection==-1){
                  console.log("no choice")
                }else{

                  enableWin("{{c}}")
                  if('{{c}}' == 'mirna'){
                    splitchar = '";"'
                  }
                  position = 'inside';
                  var radios = document.getElementsByName("radio-{{c}}");
                  for (var i = 0, length = radios.length; i < length; i++) {
                      if (radios[i].checked) {
                          // do whatever you want with the checked radio
                          position = radios[i].value;

                          document.getElementById("radio-{{c}}-inside-label").innerHTML = 'included ('+jsonData[cnvselection].{{c}}_inside_count+')';
                          document.getElementById("radio-{{c}}-cross-label").innerHTML = 'broken ('+jsonData[cnvselection].{{c}}_cross_count+')';
                          document.getElementById("radio-{{c}}-distal-label").innerHTML = 'distal ('+jsonData[cnvselection].{{c}}_distal_count+')';

                          if(position == 'inside-{{c}}'){
                            var splitgenes = jsonData[cnvselection].{{c}}_inside.split(splitchar)
                          }else if (position == 'cross-{{c}}') {
                            var splitgenes = jsonData[cnvselection].{{c}}_cross.split(splitchar)
                          }else if (position == 'distal-{{c}}') {
                            var splitgenes = jsonData[cnvselection].{{c}}_distal.split(splitchar)
                          }
                          // only one radio can be logically checked, don't check the rest
                          break;
                      }
                  }

                  for (i = 0; i < splitgenes.length; i++) {
                      if ('{{c}}' == 'mirna' && splitgenes[i]){
                        console.log(splitgenes[i])
                        var regexp = /ID=(.*);Alias=(.*);Name=(.*)[^"]*/gm;
                        var match = regexp.exec(splitgenes[i])
                        if (match){
                          genename = match[3].replace('"','')
                          geneID = match[1]
                        }else{
                          genename = '.'
                          geneID = '0'
                        }

                      }else{
                        genename = splitgenes[i]
                      }
                      if(genename!='.'){
                        if ('{{c}}' == 'mirna' && geneID){
                          $('#sel-{{c}}').append($('<option></option>').attr('value', genename+';'+geneID).text(genename+' ('+geneID+')'));
                        }else if('{{c}}' == 'coding_gene' || '{{c}}' == 'noncoding_gene' || '{{c}}'.indexOf("genelist")!== -1){
                          $('#sel-{{c}}').append($('<option></option>').attr('value', genename).text(genename.split(':')[1]+' ('+genename.split(':')[0]+')'));
                        }else{
                          $('#sel-{{c}}').append($('<option></option>').attr('value', genename).text(genename));
                        }
                      }
                    }
                }
          {% endif %}
      {% endfor %}
    };

</script>

<script>
  $(document).on("click", ".open-AddBookDialog", function () {
    $(".modal-dialog").draggable({
      handle: ".modal-header"
    });
    $('.modal-content').resizable({
      // alsoResize: ".modal-dialog",
      // alsoResize: "#modal-sel",
      // minHeight: 400,
      minWidth: 300

    });
    $('#myModal').on('show.bs.modal', function () {
        $(this).find('.modal-body').css({
            'max-height':'100%'
        });
    });
        var category = $(this).data('category');
        var position = 'inside-gene';
        var radios = document.getElementsByName("radio-"+category);
        for (var i = 0, length = radios.length; i < length; i++) {
           if (radios[i].checked) {
               // do whatever you want with the checked radio
                position = radios[i].value;
                break;
            };
        };
        document.getElementById("modal-title").innerHTML = {{nice_names|safe}}[category] + ' - ' + position.split('-')[0];
        function updateModal(){
          var modaldata = document.getElementById("sel-"+category).innerHTML;
          document.getElementById("modal-sel").innerHTML = modaldata
        }
        updateModal()
       // $(".modal-body #bookId").val( myBookId );

       // As pointed out in comments,
       // it is superfluous to have to manually call the modal.
       // $('#addBookDialog').modal('show');
  });
</script>

<script>
  $(document).on("click", ".open-genesDialog", function () {
    $(".modal-dialog").draggable({
      handle: ".modal-header"
    });
    $('.modal-content').resizable({
      // alsoResize: ".modal-dialog",
      // alsoResize: "#modal-sel",
      // minHeight: 400,
      minWidth: 300
    });
    $('#genesModal').on('show.bs.modal', function () {
        $(this).find('.modal-body').css({
            'max-height':'100%'
        });
    });

    var cnvdrop = document.getElementById("cnv-dropdown");
    cnvselection = cnvdrop.options[cnvdrop.selectedIndex].value;
    var category = $(this).data('category');
    var position = 'inside-gene';
    var genelist_choices = {{genes_choices|tojson|safe}}
    var radios = document.getElementsByName("radio-"+category);
    for (var i = 0, length = radios.length; i < length; i++) {
       if (radios[i].checked) {
           // do whatever you want with the checked radio
            position = radios[i].value;
            break;
        };
    };

    document.getElementById("genesmodal-title").innerHTML = category + ' - ' + position.split('-')[0];
    document.getElementById("classification").innerHTML = "<thead><tr id=\"header-row\"></tr></thead><tbody id=\"genestable-body\"></tbody>"

    function updategenesModal(){

      document.getElementById("header-row").innerHTML = "<th>Gene</th>"
      for (var i = 0, length = genelist_choices.length; i < length; i++){
        document.getElementById("header-row").innerHTML += "<th>"+genelist_choices[i].replace("_genelist","")+"</th>"
      }

      if(position == 'inside-gene'){
        var splitgenes = jsonData[cnvselection].gene_inside.split(';')
      }else if (position == 'cross-gene') {
        var splitgenes = jsonData[cnvselection].gene_cross.split(';')
      }else if (position == 'distal-gene') {
        var splitgenes = jsonData[cnvselection].gene_distal.split(';')
      }

      var tablehtml = ""
      for (var i = 0, length = splitgenes.length; i < length; i++){
        tablehtml += "<tr><td>"+splitgenes[i]+"</td>"
        for (var j = 0, lengthj = genelist_choices.length; j < lengthj; j++){
          genelist_position = position.replace("-gene", "")
          choice_name = genelist_choices[j].replace("genelist", genelist_position)
          if (jsonData[cnvselection][choice_name].includes(splitgenes[i])){
            tablehtml += "<td><img src=\"../static/img/smallcheck.png\" /><span style=\"opacity:0\">Y</span></td>"
          }else{
            tablehtml += "<td><img src=\"../static/img/smallcross.png\" /><span style=\"opacity:0\">N</span></td>"
          }
        }
        tablehtml += "</tr>"
      }
      document.getElementById("genestable-body").innerHTML += tablehtml

      $('#classification').DataTable().destroy();
      $('#classification').DataTable().draw();

    }


    updategenesModal()

       // $(".modal-body #bookId").val( myBookId );
       //
       // // As pointed out in comments,
       // // it is superfluous to have to manually call the modal.
       // $('#addBookDialog').modal('show');
  });
</script>

<script>
  $(document).on("click", ".open-mirbaseDialog", function () {
    $(".modal-dialog").draggable({
      handle: ".modal-header"
    });
    $('.modal-content').resizable({
      // alsoResize: ".modal-dialog",
      // alsoResize: "#modal-sel",
      // minHeight: 400,
      minWidth: 300
    });
    $('#genesModal').on('show.bs.modal', function () {
        $(this).find('.modal-body').css({
            'max-height':'100%'
        });
    });

    var cnvdrop = document.getElementById("cnv-dropdown");
    cnvselection = cnvdrop.options[cnvdrop.selectedIndex].value;
    var category = $(this).data('category');
    var position = 'inside-mirna';
    // var genelist_choices = {{genes_choices|tojson|safe}}
    var radios = document.getElementsByName("radio-"+category);
    for (var i = 0, length = radios.length; i < length; i++) {
       if (radios[i].checked) {
           // do whatever you want with the checked radio
            position = radios[i].value;
            position_index = i
            break;
        };
    };


    var mir_selects = [];

    // If we want selects only:
    //$.each($("#sel-mirna option:selected"), function(){
    //   console.log("You have selected - " + $(this).text);
    //   mir_selects.push($(this).val())
    // });

    // Else, on every miRNA:

    var all_mirnas = document.getElementById("sel-mirna");
    for (i = 0; i < all_mirnas.length; i++) {
        mir_selects.push(all_mirnas[i].value);
    }

    document.getElementById("mirbasemodal-title").innerHTML = category + ' - ' + position.split('-')[0];
    document.getElementById("mirbase-classification").innerHTML = "<thead><tr id=\"mirbaseheader-row\"></tr></thead><tbody id=\"mirbasetable-body\"></tbody>"

    function updatemirbaseModal(){
      document.getElementById("mirbaseheader-row").innerHTML = "<th>miRNA name</th><th>miRNA ID</th>"
      for (var i = 0, length = Object.keys(mirbase_jsonData).length; i < length; i++){
          document.getElementById("mirbaseheader-row").innerHTML += "<th>"+Object.keys(mirbase_jsonData)[i]+"</th>"
      }

      mirbase_tablehtml = ""

      for (var i = 0, length = mir_selects.length; i < length; i++){
        mirbase_tablehtml += "<tr><td>"+mir_selects[i].split(';')[1]+"</td>"+"<td>"+mir_selects[i].split(';')[0]+"</td>"
        for (var j = 0, length_targets = Object.keys(mirbase_jsonData).length; j < length_targets; j++){
            mir_entry = mirbase_jsonData[Object.keys(mirbase_jsonData)[j]][position_index][mir_selects[i]]
            // The mirnas are taken from the window: they could or could not be in inside,cross,distal. Must be checked.
            if (mir_entry){
                if (mir_entry[0] != ["."]){
                  mirbase_tablehtml += `<td><img src=\"../static/img/smallcheck.png\" /><a id=\"listlink\" href=\"#\" onclick=\"openlist('${mir_selects[i]}', '${position_index}', '${Object.keys(mirbase_jsonData)[j]}');return false;\" style=\"vertical-align:middle\">&nbsp&nbspList</a></td>`
                }else{
                  mirbase_tablehtml += "<td><img src=\"../static/img/smallcross.png\" /><span style=\"opacity:0\">N</span></td>"
                }
            }else{
                mirbase_tablehtml += "<td><img src=\"../static/img/smallcross.png\" /><span style=\"opacity:0\">N</span></td>"
            }
        }
        mirbase_tablehtml += "</tr>"

      }
      document.getElementById("mirbasetable-body").innerHTML += mirbase_tablehtml
      $('#mirbase-classification').DataTable().destroy();
      $('#mirbase-classification').DataTable().draw();
    };

    updatemirbaseModal();

  });
</script>


<script>
    function enableWin(category) {
        document.getElementById("modal-link-"+category).disabled = false;
        document.getElementById("checkbox-plot-"+category).disabled = false;
        if (category == 'gene' && document.getElementById("genesmodal-link")){
            document.getElementById("genesmodal-link").disabled = false;
        }
    }

    function disableWin(category) {
        document.getElementById("modal-link-"+category).disabled = true;
        document.getElementById("checkbox-plot-"+category).disabled = true;
        if (category == 'gene' && document.getElementById("genesmodal-link")){
            document.getElementById("genesmodal-link").disabled = true;
        }
    }

    function resetSwitches(){
      console.log("RESET CALLED")
      {% for c in choices %}
         document.getElementById('checkbox-plot-{{c}}').checked = false
      {% endfor %}
    }
</script>

<script>
  function openlist(entry, position, db) {
    // Fixes dual-screen position                         Most browsers      Firefox
    var w = 300;
    var h = 700;
    var dualScreenLeft = window.screenLeft != undefined ? window.screenLeft : window.screenX;
    var dualScreenTop = window.screenTop != undefined ? window.screenTop : window.screenY;

    var width = window.innerWidth ? window.innerWidth : document.documentElement.clientWidth ? document.documentElement.clientWidth : screen.width;
    var height = window.innerHeight ? window.innerHeight : document.documentElement.clientHeight ? document.documentElement.clientHeight : screen.height;

    var left = ((width / 2) - (w / 2)) + dualScreenLeft;
    var top = ((height / 2) - (h / 2)) + dualScreenTop;
    var newWindow = window.open('about:blank', 'Genes', 'scrollbars=yes, width=' + w + ', height=' + h + ', top=' + top + ', left=' + left);
    newWindow.document.title = "Genes";
    // Puts focus on the newWindow
    if (window.focus) {
        newWindow.focus();
    }

    newWindow.document.write("<script>function downloadFile() {var a = document.createElement(\"a\"); a.download = \""+entry.split(';')[0]+"_"+db+"_genes.txt\"; a.href = \"data:text/html,\" + document.getElementById(\"mirna-genes\").innerText; document.body.appendChild(a); a.click();}<\/script><title>"+entry.split(';')[0]+" in "+db+"<\/title><div><p>Genes for "+entry.split(';')[0]+" in "+ db + " (<a href=\"#\" onclick=downloadFile()>Download</a>):</p></div><div id=\"mirna-genes\"></div>");

    // function downloadList(){
    //     document.location =
    //         'data:text/attachment;,' +
    //         document.getElementById('mirna-genes').innerHTML;
    // };

    var genes = mirbase_jsonData[db][position][entry];
    var uniquegenes = [];
    $.each(genes, function(i, el){
        if($.inArray(el, uniquegenes) === -1) uniquegenes.push(el);
    });
    for(var i = 0; i < uniquegenes.length; i++) {
      newWindow.document.getElementById("mirna-genes").innerHTML += uniquegenes[i]+"<br />"
    }
  }
</script>

<script>
  function get_genome_position(){
    var cnvdrop = document.getElementById("cnv-dropdown");
    cnvselection = cnvdrop.options[cnvdrop.selectedIndex].value;
    cnvtext = cnvdrop.options[cnvdrop.selectedIndex].text

    var cnvregexp = /chr([XYM\d]+):\s(\d+)\s-\s(\d+)/gm;
    return cnvregexp.exec(cnvtext)
  }
</script>

{% endblock %}

{% block title %}Results{% endblock %}
{% block navbar %}
{{ super() }}
{% endblock %}

{% block content %}

<div class="parallax filter-gradient blue" data-color="blue" style="height:135px !important;">
    <div class="parallax-background">
        <img src="../static/img/dna2.png">
    </div>
</div>
<div class= "section section-gray section-clients" style="padding-top:10px; height: fit-content;">
  <div id="results-container" class="results-container container">
      <h2 style="margin-left:30px; margin-bottom: 40px; color: #307ba0; font-size:40px; text-shadow: 1px 1px 3px rgba(150, 150, 150, 0.56);">Results</h2>
    <div style="display:-webkit-box; margin-left: 30px;">
        <div id="dropdown-div" style="display: -webkit-inline-box; vertical-align: -webkit-baseline-middle;">

        <select data-style="btn-new" id="cnv-dropdown" name="CNVs"></select>

        <script>
            let dropdown = $('#cnv-dropdown');

            // dropdown.empty();

            dropdown.append('<option selected="true" value="-1" disabled>Choose CNV</option>');
            dropdown.prop('selectedIndex', 0);

            // Populate dropdown with list of CNVs
            $.getJSON("{{ json_out }}", function (data) {
            $.each(data, function (key, entry) {
              dropdown.append($('<option></option>').attr('value', entry.index).text(entry.CHR+": "+entry.START+" - "+entry.END));
            })
            });

            document.getElementById('cnv-dropdown').addEventListener('change',function(){
              console.log("MATCH")
              var match = get_genome_position()
              console.log(match)
              var cnv_id = document.getElementById('cnv-dropdown').value
              chr = match[1]
              start = match[2]
              end = match[3]
              updatebrowser(chr, start, end, cnv_id, tracks=[]);
              resetSwitches()
              updateGenes(cnvselection, jsonData);
            });
        </script>
        <!-- <script>

            let dropdown = $('#cnv-dropdown');

            // dropdown.empty();

            // Populate dropdown with list of CNVs
            $.getJSON("{{ json_out }}", function (data) {
              document.getElementById("cnv-dropdown").selectedIndex = 0;

                $.each(data, function (key, entry) {
                  console.log("KEY")
                  console.log(key)
                  if(key==0){
                    console.log("ENTRY INDEX")
                    console.log(entry.index)
                    dropdown.append($('<option></option>').attr('value', entry.index).attr('selected', true).text(entry.CHR+": "+entry.START+" - "+entry.END));
                  }else{
                    dropdown.append($('<option></option>').attr('value', entry.index).text(entry.CHR+": "+entry.START+" - "+entry.END));
                  }
                })
                console.log(document.getElementById("cnv-dropdown").selectedIndex)
            });

            $( "#cnv-dropdown").change(function(){
              onchange_dropdown()
            });

        </script> -->
        </div>
        <div id="arrow" class="red-arrow animate-flicker">
          <p>
          </p>
        </div>
        <div id="download-div">
            <span id="download-span">
              or download results as an</span>
            <div id="down-buttons">
                  <a class="btn btn-success btn-lg active" href="{{file_out}}" download="{{download_name}}"
                  style="font-size: 14px; vertical-align: baseline; padding: 5px 15px 5px 15px; background-color: #16821f; color: #ffffff;border-color: #34aa3a;"
                  role="button" aria-pressed="true">
                  Excel File</a>&nbsp or &nbsp<a class="btn btn-success btn-lg active" href="{{text_file_out}}" download="{{text_download_name}}"
                  style="font-size: 14px; vertical-align: baseline; padding: 5px 15px 5px 15px; background-color: #ea7900; color: #ffffff;border-color: #ffba58;"
                  role="button" aria-pressed="true">CSV File</a>
            </div>

        </div>
    </div>

    <br>
    <!-- Genoverse -->

    <div id="genoverse-wrap">
      <div id="genoverse"></div>
    </div>

    <!-- Panels -->
    <div id="panellist-div" class="row draggablePanelList" style="margin-top: 35px; margin-right: 15px; margin-left: 15px;">
    {% for c in choices %}
      {% if (c!='mirbase') and (c!='gene') %}
            <div class="col-sm-4">
              <div class="panel panel-info">
                       {% if c.endswith('_genelist') %}
                         <div class="panel-heading" style="font-weight: bold; color: #ffffff; background-color: #45af35 !important; border-color: #16821f !important">
                       {% else %}
                         <div class="panel-heading" style="font-weight: bold; color: #ffffff; background-color: #307ba0; border-color: #307ba0">
                       {% endif %}
                             {{nice_names[c]}}

                             <div class="help-tip" style="background-color: #ffd400">
                               <p>{{ info[c] }}
                             </p>
                             </div>

                               <input type="checkbox" class="ios8-switch ios8-switch-sm" id="checkbox-plot-{{c}}">
                               <label for="checkbox-plot-{{c}}">Show</label>
                               <script>
                                   console.log("checking ", '{{c}}')
                                   var plot_switches = {}
                                   $(document).ready(function() {
                                     $("#checkbox-plot-{{c}}").click(function(){
                                           for(var p = 0; p < {{choices|tojson|safe}}.length; p++) {
                                             category = {{choices|tojson|safe}}[p]
                                             plot_switches[category] = $('#checkbox-plot-'+category).is(':checked')
                                           }

                                           var match = get_genome_position()
                                           var cnv_id = document.getElementById('cnv-dropdown').value
                                           chr = match[1]
                                           start = match[2]
                                           end = match[3]
                                           updatebrowser(chr, start, end, cnv_id, plot_switches);

                                     });
                                   });
                               </script>
                        </div>

                <div class="panel-body">
                  <form>

                    <div id="radios">
                        <div class="radio-inline">
                          <label class="form-check-label-{{c}}">
                          <input type="radio" class="form-check-input" name="radio-{{c}}" id="inside-{{c}}" value="inside-{{c}}"
                          checked><span id="radio-{{c}}-inside-label">included (0)</span>
                          </label>
                        </div>
                        <div class="radio-inline">
                          <label class="form-check-label-{{c}}">
                          <input type="radio" class="form-check-input" name="radio-{{c}}" id="cross-{{c}}" value="cross-{{c}}"
                          unchecked><span id="radio-{{c}}-cross-label">broken (0)</span>
                          </label>
                        </div>
                        <div class="radio-inline">
                          <label class="form-check-label-{{c}}">
                          <input type="radio" class="form-check-input" name="radio-{{c}}" id="distal-{{c}}" value="distal-{{c}}"
                          unchecked><span id="radio-{{c}}-distal-label">distal (0)</span>
                          </label>
                        </div>
                        <div class="help-tip-blue">
                          <p>You can select among three subsets of <b>{{nice_names[c]}}:</b><br /><br />
                            &nbsp;&nbsp;- <b>included</b>: completely overlapping with the CNV<br />
                            &nbsp;&nbsp;- <b>broken</b>: including the CNV breakpoints<br />
                            &nbsp;&nbsp;- <b>distal</b>: lying within a user-defined genomic window from the CNV boundaries<br />
                          </p>
                        </div>
                    </div>

                    <select size="7" class="form-control" id="sel-{{c}}"></select>
                    <div>

                    </div>
                    <div style="position:relative; margin-top:10px; min-height: 36px;">

                   {% if c.endswith('_genelist') %}
                       <button class="btn" type="button" id="getSelectsBtn-{{c}}"
                       style="padding: 4px 8px; border-width: 1px;">
                       <img src="../static/img/gc_small.png" style="max-width:100%" /></button>
                       <script>
                         $(document).ready(function() {
                             $("#getSelectsBtn-{{c}}").click(function(){
                                 $.each($("#sel-{{c}} option:selected"), function(){
                                   window.open("https://www.genecards.org/cgi-bin/carddisp.pl?gene="+$(this).val().split(':')[0], '_blank');
                                   // window.focus();
                                   console.log("You have selected - " + $(this).val().split(':')[0]);
                                 });
                             });
                         });
                       </script>
                       <!-- {% if genes_choices!=[] %}
                           <a id="genesmodal-link" href="#genesModal" data-toggle="modal" data-category="{{c}}" data-position=""
                           data-backdrop="false" title="Add this item" class="open-genesDialog new-win btn" style="position:relative">
                           Classification
                           </a>
                       {% endif %} -->
                   {% endif %}

                   {% if c == 'enhancer' %}
                       <button id="enhancer-link" class="btn" type="button" style="position:relative">Full annotation</button>
                   {% endif %}

                   {% if c == 'longNC' %}
                       <button class="btn" type="button" id="getSelectsBtn-{{c}}"
                       style="padding: 5px 8px; border-width: 1px; color: #427c70; font-size:17px;">
                       <b>LNC</b>ipedia</button>
                       <script>
                         $(document).ready(function() {
                             $("#getSelectsBtn-{{c}}").click(function(){
                                 $.each($("#sel-{{c}} option:selected"), function(){
                                   window.open("https://lncipedia.org/db/transcript/"+$(this).val(), '_blank');
                                   // window.focus();
                                   console.log("You have selected - " + $(this).val());
                                 });
                             });
                         });
                       </script>
                   {% endif %}

                    {% if c == 'mirna' %}
                        <button class="btn" type="button" id="getSelectsBtn-{{c}}"
                        style="padding: 8px 8px; font-size:95%; font-weight: bold; color:#d60000; border-width: 1px;">miRBase
                        </button>
                        <script>
                          $(document).ready(function() {
                              $("#getSelectsBtn-{{c}}").click(function(){
                                  $.each($("#sel-{{c}} option:selected"), function(){
                                    window.open("http://www.mirbase.org/cgi-bin/mirna_entry.pl?acc="+$(this).val().split(';')[0], '_blank');
                                    // window.focus();
                                    console.log("You have selected - " + $(this).val());
                                  });
                              });
                          });
                        </script>

                        {% if 'mirbase' in choices %}
                          <a id="mirbasemodal-link" href="#mirbaseModal" data-toggle="modal" data-category="{{c}}" data-position=""
                          data-backdrop="false" title="Add this item" class="open-mirbaseDialog new-win btn" style="position:relative">
                          Targets
                          </a>
                        {% endif %}

                    {% endif %}

                    {% if c == 'pseudogene' %}
                        <button class="btn" type="button" id="getSelectsBtn-{{c}}"
                        style="padding: 5px 8px 9px 8px; border-width: 1px;">
                        <img src="../static/img/ensembl_small.png" style="max-width:100%" /></button>
                        <script>
                          $(document).ready(function() {
                              $("#getSelectsBtn-{{c}}").click(function(){
                                  $.each($("#sel-{{c}} option:selected"), function(){
                                    window.open("https://www.ensembl.org/Homo_sapiens/Gene/Summary?db=core;t="+$(this).val(), '_blank');
                                    // window.focus();
                                    console.log("You have selected - " + $(this).val());
                                  });
                              });
                          });
                        </script>
                    {% endif %}
                    <a id="modal-link-{{c}}" href="#myModal" data-toggle="modal" data-category="{{c}}" data-position=""
                    data-backdrop="false" title="Add this item" class="open-AddBookDialog new-win">
                    <img src="../static/img/newwin.png"></a>
                    <script>
                      disableWin("{{c}}")
                    </script>
                  </div>
                  </form>
                </div>
              </div>
            </div>
        {% endif %}
    {% endfor %}
    <script>
        var cnvdrop = document.getElementById("cnv-dropdown");
        console.log("Selected index")
        console.log(document.getElementById("cnv-dropdown").selectedIndex)
        console.log("cnv drop")
        console.log(cnvdrop)

        if(document.getElementById("cnv-dropdown").selectedIndex!=-1 && jsonData!=null){
          cnvselection = document.getElementById("cnv-dropdown").options[document.getElementById("cnv-dropdown").selectedIndex].value;
          {% for c in choices %}
          var radios = document.getElementsByName("radio-{{c}}");
          var prev = null;
          for(var i = 0; i < radios.length; i++) {
              radios[i].onclick = function() {
                  console.log("CHANGED RADIO! for cnv")
                  console.log(cnvselection)

                  updateGenes(cnvselection, jsonData)
              };
          }
          {% endfor %}
        }

    </script>

    <script>
        $('#enhancer-link').click(function(){
          $.ajax({
            dataType: "json",
            url: "{{ json_out }}".replace(".json", "_extra.json"),
            async: false,
            success: function(data){
              extra_jsonData = data;
              console.log("LOADED EXTRA")

            },
            error: function (data) {
              var responseText=JSON.parse(data.responseText);
              alert("Error(s) while building:\n"+responseText.messages);}
          });
          var enh_radios = document.getElementsByName("radio-enhancer");
          console.log("RADIOS")
          console.log(enh_radios)
          for (var i = 0, length = enh_radios.length; i < length; i++) {
             console.log(i+" "+enh_radios[i].checked)
             if (enh_radios[i].checked) {
                 // do whatever you want with the checked radio
                  enh_position = enh_radios[i].value;
                  break;
              };
          };
          console.log("POSITION "+enh_position)
          // cnvselection = document.getElementById("cnv-dropdown").options[document.getElementById("cnv-dropdown").selectedIndex].text
          JSONToCSVConverter(extra_jsonData, "Enhancers annotation", true, cnvselection, "enhancer", enh_position.split('-')[0]);
        });
    </script>
    </div>

  </div>


</div>
<!-- Trigger/Open The Modal -->


<div id="myModal" class="modal fade">
    <div class="modal-dialog">
        <div class="modal-content" style="min-height:400px; max-width:300px">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                 <h4 class="modal-title" id="modal-title" style="text-transform:capitalize">Title</h4>

            </div>
            <div class="modal-body" style="height:calc(100% - 100px);">
              <select multiple class="form-control" id="modal-sel"
                style=" min-height: calc(100% - 25px); height:280px"></select>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                <button id="loadpage" type="button" class="btn btn-primary">Download selected</button>
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>


<div id="genesModal" class="modal fade">
    <div class="modal-dialog">
        <div class="modal-content" style="min-height:400px; height:fit-content ;width: fit-content; min-width:605px;">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                 <h4 class="modal-title" id="genesmodal-title" style="text-transform:capitalize">Title</h4>

            </div>
            <div class="modal-body" style="height:calc(100% - 100px);">
                <table id="classification" class="table table-striped table-bordered">
                </table>
            </div>
            <div class="modal-footer">
                <!-- <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button> -->
                <!-- <button id="genesloadpage" type="button" class="btn btn-primary">Download selected</button> -->
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
<!-- /.modal -->


<div id="mirbaseModal" class="modal fade">
    <div class="modal-dialog">
        <div class="modal-content" style="min-height:400px; height:fit-content ;width: fit-content; min-width:585px;">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                 <h4 class="modal-title" id="mirbasemodal-title" style="text-transform:capitalize">Title</h4>

            </div>
            <div class="modal-body" style="height:calc(100% - 100px);">
                <table id="mirbase-classification" class="table table-striped table-bordered">
                </table>
            </div>
            <div class="modal-footer">
                <!-- <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button> -->
                <!-- <button id="genesloadpage" type="button" class="btn btn-primary">Download selected</button> -->
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>

  <!-- <script type="text/javascript" src="../static/angularjs-genoverse/lib/Genoverse/js/lib/Base.js"></script>
  <script type="text/javascript" src="../static/angularjs-genoverse/lib/Genoverse/js/Genoverse.js"></script>
  <script type="text/javascript" src="../static/angularjs-genoverse/lib/Genoverse/js/Track/Controller.js"></script> -->
  <!-- <script type="text/javascript" src="../static/angularjs-genoverse/lib/Genoverse/js/Track/Model.js"></script>
  <script type="text/javascript" src="../static/angularjs-genoverse/lib/Genoverse/js/Track/View.js"></script> -->
  <!-- <script type="text/javascript" src="../static/angularjs-genoverse/lib/Genoverse/js/Track/Controller/Sequence.js"></script>
  <script type="text/javascript" src="../static/angularjs-genoverse/lib/Genoverse/js/Track.js"></script> -->
  <script type="text/javascript" src="../static/angularjs-genoverse/lib/Genoverse/js/genoverse.min.js"></script>
  <script type="text/javascript" src="../static/angularjs-genoverse/lib/Genoverse/js/genomes/grch37.js"></script>


  <script>
        function updatebrowser(chr, start, end, cnv_id, tracks=[]){
            console.log("PLOTTING CNV id"+cnv_id)
            console.log(chr, start, end)
            document.getElementById("genoverse").innerHTML = '';
            var colorsdict = {"gene": "#16a086",
                "ID_genelist": "#16a086",
                "dosage_sensitive_genelist": "#16a086",
                "mendeliome_genelist": "#16a086",
                "ohnologs_genelist": "#16a086",
                "imprinted_genelist": "#16a086",
                "coding_gene": "#27ae61",
                "noncoding_gene": "#34495e",
                "longNC": "#2a80b9",
                "mirna": "#c1392b",
                "circRNA": "#d25400",
                "pseudogene": "#7e8c8d",
                "ucr": "#8f44ad",
                "har": "#9b58b5",
                "enhancer": "#5d562e"}
            ext_start = parseInt(start) - {{distance}}
            ext_end = parseInt(end) + {{distance}}
            var genoverseConfig = {
              container : '#genoverse', // Where to inject Genoverse (css/jQuery selector/DOM element)
              // If no genome supplied, it must have at least chromosomeSize, e.g.:
              // chromosomeSize : 249250621, // chromosome 1, human
              genome    : 'grch37', // see js/genomes/
              chr       : chr,
              start     : ext_start-500000,
              end       : ext_end,
              plugins   : [ 'controlPanel', 'karyotype', 'trackControls', 'resizer', 'focusRegion', 'fullscreen', 'tooltips', 'fileDrop' ],
              tracks    : [
                Genoverse.Track.Scalebar,
                Genoverse.Track.extend({
                  name       : 'Sequence',
                  url        : 'http://grch37.rest.ensembl.org/sequence/region/human/__CHR__:__START__-__END__?content-type=text/plain',
                  controller : Genoverse.Track.Controller.Sequence,
                  model      : Genoverse.Track.Model.Sequence.Ensembl,
                  view       : Genoverse.Track.View.Sequence,
                  100000     : false,
                  resizable  : 'auto'
                }),

                Genoverse.Track.extend({
                  name            : 'CNV',
                  resizable       : 'auto',
                  subFeatureJoinStyle : 'line',
                  labels : 'overlay',
                  fontColor: 'white',
                  fontWeight: 'bold',
                  subFeatureJoinLineWidth : 15,
                  featureMargin: {
                    top:10,
                    right:1,
                    bottom:1,
                    left:0
                  },
                  data:[{
                              chr: chr,
                              start: ext_start,
                              end: ext_end,
                              color: '#CC0000'
                            }],
                  parseData: function (data, chr) {
                    var feature = data[0];
                    var subfeatures = [];
                    var leftlimit =  {
                      start: start - {{distance}},
                      end: start,
                      color: '#004C99',
                    }
                    subfeatures.push(leftlimit);

                    var rightlimit =  {
                      start: end,
                      end: parseInt(end) + parseInt({{distance}}),
                      color: '#004C99'
                    }
                    subfeatures.push(rightlimit);

                    feature.subFeatures = subfeatures;
                    feature.id = 'CNV '+start+'-'+end;
                    feature.label = 'CNV';
                    this.insertFeature(feature);

                  }
                }),

                // Genoverse.Track.Gene37,
                // Genoverse.Track.Gene,
                // Genoverse.Track.Gene.extend({
                //   name       : 'Genes',
                //   url        : 'http://grch37.rest.ensembl.org/overlap/region/human/__CHR__:__START__-__END__?feature=gene;content-type=application/json',
                //   parseData: function (data, chr) {
                //     for (var i = 0; i < data.length; i++) {
                //       var feature = data[i];
                //
                //       if (feature.feature_type === 'gene' && !this.featuresById[feature.id]) {
                //         feature.chr         = feature.chr || chr;
                //         feature.label       = parseInt(feature.strand, 10) === 1 ? (feature.external_name || feature.id) + ' >' : '< ' + (feature.external_name || feature.id);
                //         feature.transcripts = [];
                //
                //         this.insertFeature(feature);
                //       }
                //     }
                //   }
                // }),
                // Genoverse.Track.extend({
                //   name            : 'Regulatory Features',
                //   url             : 'http://rest.ensembl.org/overlap/region/human/__CHR__:__START__-__END__?feature=regulatory;content-type=application/json',
                //   resizable       : 'auto',
                //   model           : Genoverse.Track.Model.extend({ dataRequestLimit : 5000000 }),
                //   setFeatureColor : function (f) { f.color = '#AAA'; }
                // }),
                // Genoverse.Track.extend({
                //   name            : 'Genes37',
                //   url             : 'http://grch37.rest.ensembl.org/overlap/region/human/__CHR__:__START__-__END__?feature=gene;content-type=application/json',
                //   resizable       : 'auto',
                //   model           : Genoverse.Track.Model.extend({ dataRequestLimit : 5000000 }),
                //   setFeatureColor : function (f) { f.color = '#AAA'; }
                // }),
              ]
            };
            console.log("IN HERE");
            console.log(tracks)

            for (var t = 0; t < Object.keys(tracks).length; t++) {
              var splitchar = ';';
              cat = Object.keys(tracks)[t]
              var newtrack = {};
              var all_keys = []
              if(tracks[cat] == true){
                if (cat == "mirna"){
                  splitchar = '";'
                }

                for (var n =0; n<jsonData[cnv_id][cat+"_inside"].split(splitchar).length; n++){
                  feature_name = jsonData[cnv_id][cat+"_inside"].split(splitchar)[n].replace('"','');
                  if (cat == "mirna" && feature_name!='.'){
                    feature_name = feature_name.split('Name=')[1]
                  }
                  if(feature_name!='.'){
                    newtrack[feature_name] = {
                      chr: chr,
                      start: jsonData[cnv_id][cat+"_inside_coords"].split(';')[n].split('-')[0],
                      end: jsonData[cnv_id][cat+"_inside_coords"].split(';')[n].split('-')[1],
                      color: colorsdict[cat],
                      assembly_name: "GRCh37",
                      biotype: "gene",
                      description: "",
                      external_name: feature_name,
                      feature_type: "gene",
                      gene_id: feature_name,
                      id: feature_name,
                      source: {{sources|tojson|safe}}[cat],
                      logic_name: '',
                      strand: 1,
                      version:11
                    }
                  if(cat == 'coding_gene' || cat == 'noncoding_gene' || cat.indexOf("genelist")!== -1){
                    newtrack[feature_name]['external_name'] = feature_name.split(':')[0];
                    newtrack[feature_name]['id'] = feature_name.split(':')[1];

                  }
                }
              }

              for (var n =0; n<jsonData[cnv_id][cat+"_cross"].split(splitchar).length; n++){
                feature_name = jsonData[cnv_id][cat+"_cross"].split(splitchar)[n].replace('"','');
                if (cat == "mirna" && feature_name!='.'){
                  feature_name = feature_name.split('Name=')[1]
                }
                if(feature_name!='.'){
                  newtrack[feature_name] = {
                    chr: chr,
                    start: jsonData[cnv_id][cat+"_cross_coords"].split(';')[n].split('-')[0],
                    end: jsonData[cnv_id][cat+"_cross_coords"].split(';')[n].split('-')[1],
                    color: colorsdict[cat],
                    assembly_name: "GRCh37",
                    biotype: "gene",
                    description: "",
                    external_name: feature_name,
                    feature_type: "gene",
                    gene_id: feature_name,
                    id: feature_name,
                    source: {{sources|tojson|safe}}[cat],
                    logic_name: '',
                    strand: 1,
                    version:11
                  }
                  if(cat == 'coding_gene' || cat == 'noncoding_gene' || cat.indexOf("genelist")!== -1){
                    newtrack[feature_name]['external_name'] = feature_name.split(':')[0];
                    newtrack[feature_name]['id'] = feature_name.split(':')[1];

                  }
                }

              }

              for (var n =0; n<jsonData[cnv_id][cat+"_distal"].split(splitchar).length; n++){
                console.log("Plotting")
                console.log(jsonData[cnv_id][cat+"_distal_coords"].split(';')[n].split('-')[0], jsonData[cnv_id][cat+"_distal_coords"].split(';')[n].split('-')[1],)
                feature_name = jsonData[cnv_id][cat+"_distal"].split(splitchar)[n].replace('"','');
                if (cat == "mirna" && feature_name!='.'){
                  feature_name = feature_name.split('Name=')[1]
                }
                if(feature_name!='.'){
                  newtrack[feature_name] = {
                    chr: chr,
                    start: jsonData[cnv_id][cat+"_distal_coords"].split(';')[n].split('-')[0],
                    end: jsonData[cnv_id][cat+"_distal_coords"].split(';')[n].split('-')[1],
                    color: colorsdict[cat],
                    assembly_name: "GRCh37",
                    biotype: "gene",
                    description: "",
                    external_name: feature_name,
                    feature_type: "gene",
                    gene_id: feature_name,
                    id: feature_name,
                    source: {{sources|tojson|safe}}[cat],
                    logic_name: '',
                    strand: 1,
                    version:11
                  }

                  if(cat == 'coding_gene' || cat == 'noncoding_gene' || cat.indexOf("genelist")!== -1){
                    newtrack[feature_name]['external_name'] = feature_name.split(':')[0];
                    newtrack[feature_name]['id'] = feature_name.split(':')[1];

                  }
                }
              }



                trackconfig = Genoverse.Track.Gene.extend({
                  name:    {{nice_names|tojson|safe}}[cat],
                  resizable       : 'auto',
                  subFeatureJoinStyle : 'line',
                  model      : Genoverse.Track.Model.Gene,
                  view       : Genoverse.Track.View.Gene,
                  labels : 'overlay',
                  fontColor: colorsdict[cat],
                  subFeatureJoinLineWidth : 15,
                  featureHeight:    6,
                  featureMargin: {
                    top:10,
                    right:1,
                    bottom:1,
                    left:0
                  },
                  data: Object.values(newtrack),
                  parseData: function (data, chr) {
                    for (var i = 0; i < data.length; i++) {
                      var feature = data[i];

                      if (feature.feature_type === 'gene') {
                        feature.chr         = feature.chr || chr;
                        feature.label       = (feature.external_name || feature.id);
                        feature.transcripts = [];

                        this.insertFeature(feature);
                      }
                    }
                  }

                });

              genoverseConfig.tracks.push(trackconfig);

            }

            }

            new Genoverse(genoverseConfig);

        };
  </script>
<!-- <genoverse genome="genome" chromosome="chromosome" start="start" end="end" example-locations="exampleLocations">
    <genoverse-track name="'Sequence'" model="Genoverse.Track.Model.Sequence.Ensembl" view="Genoverse.Track.View.Sequence" controller="Genoverse.Track.Controller.Sequence" url="urls.sequence" resizable="'auto'" auto-height="true" extra="{100000: false}"></genoverse-track>
    <genoverse-track name="'Genes'" labels="true" info="'Ensembl API genes'" model="Genoverse.Track.Model.Gene.Ensembl" view="Genoverse.Track.View.Gene.Ensembl" url="urls.genes" resizable="'auto'" auto-height="true"></genoverse-track>
    <genoverse-track name="'Transcripts'" labels="true" info="'Ensembl API transcripts'" model="Genoverse.Track.Model.Transcript.Ensembl" view="Genoverse.Track.View.Transcript.Ensembl" url="urls.transcripts" resizable="'auto'" auto-height="true"></genoverse-track>
</genoverse> -->
<script>
  console.log("Full JSON")
  console.log(jsonData)
  console.log("mirna JSON")
  console.log(mirbase_jsonData)
  console.log("Extra data")
  console.log(extra_jsonData)


</script>



<!-- /.modal -->

{% endblock %}
</div>
